class BaseProcessor extends AudioWorkletProcessor{constructor(t){super();var r=this;this.port.onmessage=function(s){"set-property"==s.data.action?r[s.data.param]=s.data.value:"list-properties"==s.data.action&&r.port.postMessage({response:"list-properties",properties:t})}}}class QDSProcessor extends BaseProcessor{constructor(){super(["w","dither","dithertype","noiseshaping","noiseshapingfilter"]),this.qt=.25,this.withDither=!1,this.ditherstate=new Float32Array(0),this.dithergen=this.rectDither,this.withNoiseShaping=!0,this.h=Float32Array.from([1]),this.nsState=new Array(0)}setChannelCount(t){if(this.ditherstate.length!=t&&(this.ditherstate=new Float32Array(t)),this.nsState.length!=t){this.nsState=new Array(t);for(var r=0;r<this.nsState.length;r++)this.nsState[r]=new Float32Array(this.h.length)}}set w(t){this.qt=Math.pow(2,1-t)}set dither(t){this.withDither=t}set dithertype(t){"rect"==t?this.dithergen=this.rectDither:"tri"==t?this.dithergen=this.triDither:"hp"==t&&(this.dithergen=this.hpDither,this.ditherstate=0)}set noiseshaping(t){this.withNoiseShaping=t}set noiseshapingfilter(t){1==t?this.h=Float32Array.from([1]):2==t?this.h=Float32Array.from([2,-1]):3==t?this.h=Float32Array.from([1.623,-.982,.109]):5==t?this.h=Float32Array.from([2.033,-2.165,1.959,-1.59,.6149]):9==t&&(this.h=Float32Array.from([2.412,-3.37,3.937,-4.174,3.353,-2.205,1.281,-.569,.0847]));for(var r=0;r<this.nsState.length;r++)this.nsState[r]=new Float32Array(this.h.length)}rectDither(t){return Math.random()-.5}triDither(t){return Math.random()+Math.random()-1}hpDither(t){var r=Math.random()-.5,s=r-this.ditherstate[t];return this.ditherstate[t]=r,s}process(t,r,s){this.setChannelCount(t[0].length);for(var e=0;e<t[0].length;e++)for(var h=t[0][e],i=r[0][e],a=0;a<h.length;a++){var o=h[a];if(this.withNoiseShaping)for(var n=0;n<this.h.length;n++)o-=this.h[n]*this.nsState[e][n];var l=0;this.withDither&&(l=this.dithergen(e));var p=o,d=this.qt*Math.round(p/this.qt+l);for(n=this.h.length-1;n>=0;n--)this.nsState[e][n]=this.nsState[e][n-1];this.nsState[e][0]=d-o,i[a]=d}return!0}}registerProcessor("qds-processor",QDSProcessor);