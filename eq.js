import{FunctionGraph as e,setupAudio as a,setupPlayerControls as t}from"./common.js";window.addEventListener("load",(async()=>{const r=await a("eqproc.js","eq-processor");t(r,[{type:"remote",label:"Funk",url:"audio/unfinite_function.mp3"},{type:"remote",label:"Orchestra",url:"audio/captain-pretzel_ghost-gulping.wav"}]);let n=1,o=1,s=1;r.proc.type="lowpass",r.proc.bypass=!1,r.proc.parameters.get("omegaC").value=n,r.proc.parameters.get("gain").value=o,r.proc.parameters.get("Q").value=s;const m=new e(document.getElementById("funccanvas"));m.xlim=[20,2e4],m.ylim=[-20,20];const c=()=>[[n/2/Math.PI*r.sampleRate,-3]],l=()=>[[n/2/Math.PI*r.sampleRate,10*Math.log10(o>=1?(1+o*o)/2:2/(1+1/(o*o)))]],g=()=>1,p=e=>e>=0?Math.sqrt(2*Math.pow(10,e/10)-1):1/Math.sqrt(2/Math.pow(10,e/10)-1),u={lowpass:{magnitudeSquared(e,a){const t=a*(1+e);return t*t/(t*t+(1-e)*(1-e))},get markers(){return c()},gainFromMarker:g},highpass:{magnitudeSquared(e,a){const t=1-e;return t*t/(t*t+a*(1+e)*a*(1+e))},get markers(){return c()},gainFromMarker:g},lowshelving:{magnitudeSquared(e,a){const t=(1-e)*(1-e),r=a*a*(1+e)*(1+e);return o>=1?(t+o*o*r)/(t+r):(t+r)/(t+r/(o*o))},get markers(){return l()},gainFromMarker:p},highshelving:{magnitudeSquared(e,a){const t=(1-e)*(1-e),r=a*a*(1+e)*(1+e);return o>=1?(o*o*t+r)/(t+r):(t+r)/(t/(o*o)+r)},get markers(){return l()},gainFromMarker:p},peak:{magnitudeSquared(e,a){const t=(1-e)*(1-e)+a*a*(1+e)*(1+e),r=a*(1-e*e),n=s*s;return o>=1?(t+(o*o/n-2)*r)/(t+(1/n-2)*r):(t+(1/n-2)*r)/(t+(1/(o*o*n)-2)*r)},get markers(){const e=10*Math.log10(o>=1?(1+o*o)/2:2/(1+1/(o*o))),a=Math.tan(n/2),t=1/(2*s)+Math.sqrt(1+1/(4*s*s)),m=Math.atan(a*t)*r.sampleRate/Math.PI,c=Math.atan(a/t)*r.sampleRate/Math.PI,l=[[n/2/Math.PI*r.sampleRate,20*Math.log10(o)]];return c>=20&&l.push([c,e]),m<=2e4&&l.push([m,e]),l},gainFromMarker:e=>Math.pow(10,e/20)}};let h=u.lowpass;const i=()=>{const e=Math.tan(n/2),a=e*e,t=new Float32Array(500),o=new Float32Array(500);for(let e=0;e<t.length;e++){const n=20*Math.pow(10,e/(t.length-1)*3);t[e]=n;const s=2*Math.PI*n/r.sampleRate;o[e]=10*Math.log10(h.magnitudeSquared(Math.cos(s),a))}m.drawData(t,o),m.drawMarkers(h.markers)},d=(e,a)=>{e.cancelAndHoldAtTime(0),e.exponentialRampToValueAtTime(a,r.currentTime+.05)};m.addEventListener("markermove",(e=>{const a=e.valX<20?20:e.valX;if(0===e.marker)n=2*Math.PI*a/r.sampleRate,d(r.proc.parameters.get("omegaC"),n),o=h.gainFromMarker(e.valY),o>10?o=10:o<.1&&(o=.1),d(r.proc.parameters.get("gain"),o);else if(1===e.marker|2===e.marker){const e=Math.tan(n/2),t=Math.tan(Math.PI*a/r.sampleRate)/e;s=Math.abs(1/(t-1/t)),d(r.proc.parameters.get("Q"),s)}i()})),i();const M=document.getElementById("linear");M.checked=!1,M.onchange=function(e){m.logx=!e.target.checked,i()},document.getElementById("bypass").onchange=function(e){r.proc.bypass=e.target.checked},document.getElementById("type").onchange=function(e){r.proc.type=e.target.value,h=u[e.target.value],i()}}));