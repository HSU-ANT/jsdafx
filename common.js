const e="object"==typeof global?global:self,t=[].findIndex||function(e,t){let n=this.length;for(;n--;)if(e.call(t,this[n]))return n;return n},n=Object.defineProperty,i="__event-target__"+Math.random(),r=e.WeakMap||function(){return{get:e=>e[i],set(e,t){n(e,i,{configurable:!0,value:t})}}};let o=e.EventTarget;try{new o}catch(e){o=(()=>{const e=new r,i=t=>e.get(t)||o(t),o=t=>{const n=new f;return e.set(t,n),n},a=(e,t)=>{for(const i in t)n(e,i,{configurable:!0,value:t[i]})};function s(){}function l(e){const t=e.options;t&&t.once&&u.call(e.target,this.type,e.listener,e.options),"function"==typeof e.listener?e.listener.call(e.target,this):e.listener.handleEvent(this)}function c(e){return this===e.listener}function u(e,n,r){const o=i(this)[e];if(o){const e=t.call(o,c,n);-1<e&&o.splice(e,1)}}function f(){}return a(s.prototype,{addEventListener:function(e,n,r){const o=i(this),a=o[e]||(o[e]=[]);t.call(a,c,n)<0&&a.push({target:this,listener:n,options:r})},dispatchEvent:function(e){const t=i(this)[e.type];t&&(a(e,{currentTarget:this,target:this}),t.forEach(l,e),delete e.currentTarget,delete e.target);return!0},removeEventListener:u}),f.prototype=Object.create(null),s})()}var a=o;function s(e){const t=e.width,n=e.height,i=e.getContext("2d");let r=!0,o=2e4,a=50,s=null,l=0,c=-80,u=null,f=[],h=null,d=null,m=null,p=30;let v=17,g=null;const y=function(e){return(o-a)*(e-p)/(t-p)+a},T=function(e){return a*Math.pow(10,Math.log10(o/a)*(e-p)/(t-p))};let b=T;const w=function(e){return(e-a)*(t-p)/o+p},x=function(e){return Math.log10(e/a)/Math.log10(o/a)*(t-p)+p};let k=x;const A=function(e){return 10+(n-10-v)/(c-l)*(e-l)},M=function(e){const t=Math.pow(10,Math.floor(Math.log10(e)));return(e/=t)>5?e=10:e>2?e=5:e>1&&(e=2),e*t},E=function(){i.clearRect(0,0,t,n),i.font="12px sans-serif",i.textBaseline="middle",i.textAlign="end";const e=M((o-a)/(t-p)*30),f=M((l-c)/(n-v-10)*20);for(let e=Math.floor(l/f)*f;e>=c;e-=f)i.strokeStyle="rgb(0, 0, 0)",i.fillText(e,p-2,A(e));if(i.textBaseline="top",i.textAlign="center",i.setTransform(0,-1,1,0,0,0),u&&i.fillText(u,-((n-v-10)/2+10),0),i.setTransform(1,0,0,1,0,0),r){i.strokeStyle="rgb(0, 0, 0)";for(let e=Math.pow(10,Math.ceil(Math.log10(a)));e<=o;e*=10)i.fillText(e,k(e),n-v+2)}else{i.strokeStyle="rgb(0, 0, 0)";for(let t=Math.ceil(a/e)*e;t<=o;t+=e)i.fillText(t,k(t),n-v+2)}s&&i.fillText(s,p+(t-p)/2,n-v+16);for(let e=Math.floor(l/f)*f;e>=c;e-=f)i.strokeStyle="rgb(100, 100, 100)",i.beginPath(),i.moveTo(k(a),A(e)),i.lineTo(k(o),A(e)),i.stroke();if(r){let e=Math.pow(10,Math.floor(Math.log10(a))),t=Math.ceil(a/e)*e;for(i.strokeStyle="rgb(100, 100, 100)";t<=o;){i.beginPath();const n=k(t);i.moveTo(n,A(l)),i.lineTo(n,A(c)),i.stroke(),(t+=e)>=9.99*e&&(e*=10)}}else for(let t=Math.ceil(a/e)*e;t<=o;t+=e){i.beginPath();const e=k(t);i.moveTo(e,A(l)),i.lineTo(e,A(c)),i.stroke()}i.rect(k(a),A(c),k(o)-k(a),A(l)-A(c)),i.stroke(),g=i.getImageData(0,0,t,n)};var P;this.drawData=function(e,r){i.putImageData(g,0,0),i.strokeStyle="rgb(0, 0, 0)",i.save(),i.beginPath(),i.rect(p,10,t-p,n-v-10),i.clip(),i.beginPath(),i.moveTo(k(e[0]),A(r[0]));for(let t=1;t<r.length;t++)i.lineTo(k(e[t]),A(r[t]));i.stroke(),i.restore()},this.drawMarkers=function(e){i.save(),i.fillStyle="rgb(165, 0, 52)",f=[];for(const t of e)f.push([k(t[0]),A(t[1])]),i.beginPath(),i.arc(k(t[0]),A(t[1]),4,0,2*Math.PI),i.fill();i.restore()},Object.defineProperty(this,"xlim",{get:()=>[a,a],set(e){[a,o]=e,E()}}),Object.defineProperty(this,"ylim",{get:()=>[c,c],set(e){[c,l]=e,E()}}),Object.defineProperty(this,"logx",{get:()=>r,set(e){(r=e)?(b=T,k=x):(b=y,k=w),E()}}),Object.defineProperty(this,"xlabel",{get:()=>s,set(e){v=(s=e)?30:16,E()}}),Object.defineProperty(this,"ylabel",{get:()=>u,set(e){p=(u=e)?44:30,E()}}),e.addEventListener("mousedown",e=>{if(0!==e.button)return;h=null;let t=6;for(let n=0;n<f.length;n++){const i=f[n],r=Math.hypot(e.offsetX-i[0],e.offsetY-i[1]);r<=t&&(h=n,t=r)}null!==h&&(d=e.offsetX-f[h][0],m=e.offsetY-f[h][1])}),e.addEventListener("mouseup",e=>{0===e.button&&(h=null)}),e.addEventListener("mousemove",e=>{if(null===h||1!==e.buttons)return;const t=new Event("markermove");t.marker=h,t.valX=b(e.offsetX-d),t.valY=(P=e.offsetY-m,l+(P-10)*(c-l)/(n-10-v)),this.dispatchEvent(t)})}class l extends a{constructor(e){super(),s.call(this,e)}}function c(e,t){const n=new l(t);let i=!1,r=!1;Object.defineProperty(this,"drawWave",{get:()=>i,set(t){i=t,t?(n.logx=!1,n.ylim=[-1,1],n.xlim=[0,e.timeIndices.length-1],n.xlabel="time in samples",n.ylabel="amplitude"):(n.xlim=[50,2e4],n.logx=!r,n.ylim=[-130,0],n.xlabel="frequency in Hz",n.ylabel="magnitude in dB")}}),Object.defineProperty(this,"freqLinear",{get:()=>r,set(e){r=e,i||(n.logx=!r)}}),this.drawWave=!1,function t(){if(setTimeout(()=>requestAnimationFrame(t),40),i){const t=e.getTimeDomainData();n.drawData(e.timeIndices,t)}else{const t=e.getFrequencyDomainData();n.drawData(e.frequencies,t)}}()}async function u(e,t){const n=new(window.AudioContext||window.webkitAudioContext)({latencyHint:"playback"});let i=null,r=null;const o=n.createAnalyser();o.smoothingTimeConstant=.3,o.minDecibels=-130,o.fftSize=1024;const a=new Float32Array(o.fftSize),s=new Float32Array(o.frequencyBinCount);o.connect(n.destination);let l=function(){};await n.audioWorklet.addModule(e);const c=new AudioWorkletNode(n,t);c.port.postMessage({action:"list-properties"});const u=await(e=>new Promise(t=>{const n=e.onmessage;e.onmessage=(i=>{e.onmessage=n,t(i.data)})}))(c.port);if("list-properties"===u.response)for(const e of u.properties)Object.defineProperty(c,e,{set(t){c.port.postMessage({action:"set-property",param:e,value:t})}});const f=new Float32Array(o.frequencyBinCount);for(let e=0;e<f.length;e++)f[e]=e*n.sampleRate/2/(f.length-1);const h=new Float32Array(o.fftSize);for(let e=0;e<h.length;e++)h[e]=e;const d=function(){null!==i&&(i.disconnect(),i=null),null!==r&&(r.disconnect(),r=null),c.disconnect(),n.suspend()};return d(),{start:function(e){d(),n.resume(),e instanceof AudioBuffer?((i=n.createBufferSource()).buffer=e,i.onended=(()=>{d(),l()}),i.start(),i.connect(c)):"sine"===e.type&&((i=n.createOscillator()).type="sine",i.frequency.value=e.frequency,i.start(),(r=n.createGain()).gain.value=e.gain,i.connect(r),r.connect(c)),c.connect(o)},stop:d,isPlaying:()=>null!==i,createBuffer:e=>new Promise(t=>{n.decodeAudioData(e,t)}),set onended(e){l=e},getTimeDomainData:function(){return o.getFloatTimeDomainData(a),a},timeIndices:h,getFrequencyDomainData:function(){return o.getFloatFrequencyData(s),s},frequencies:f,proc:c,get currentTime(){return n.currentTime},get sampleRate(){return n.sampleRate}}}function f(e,t){const n=[];let i=null;const r=document.getElementById("source-select"),o=r.children[1];r.children[0].addEventListener("click",e=>{e.stopPropagation(),o.style.visibility="visible"===o.style.visibility?"hidden":"visible"},!1),document.addEventListener("click",()=>{o.style.visibility="hidden"},!1);const a=document.getElementById("play"),s=document.getElementById("stop");function l(){e.isPlaying()?(a.disabled=!0,s.disabled=!1):(s.disabled=!0,a.disabled=!n[i])}function c(t){i=t.getAttribute("data-source-idx"),r.children[0].innerText=t.textContent,function e(t){t.classList.remove("selected"),Array.from(t.children).forEach(e)}(o),t.classList.add("selected"),e.stop(),l()}function u(e,t){e.innerText=t,e.getAttribute("data-source-idx")===i&&(r.children[0].innerText=t)}t.forEach(async function(t){const i=document.createElement("div");i.setAttribute("data-source-idx",n.length),o.children[0].append(i);const r=n.length;if(i.addEventListener("click",e=>{c(e.target)}),"remote"===t.type){i.innerText=`${t.label} (loading...)`,n.push(null);const o=await window.fetch(t.url);n[r]=await e.createBuffer(await o.arrayBuffer()),u(i,t.label)}else if("sine"===t.type){const e=t.frequency||440;i.innerText=t.label||`${e} Hz sine`,n.push({type:"sine",frequency:e,gain:t.gain||.5})}l()}),e.onended=l,s.onclick=function(){e.stop(),l()},a.onclick=function(){e.start(n[i]),l()};const f=o.children[1],h=f.children[0],d=document.createElement("input");d.type="file",d.accept="audio/*",d.addEventListener("change",async t=>{const i=t.target.files[0];if(!i)return;const r=document.createElement("div");r.setAttribute("data-source-idx",n.length),r.innerText=`${i.name} (loading...)`,c(r),f.insertBefore(r,h);const o=n.length;r.addEventListener("click",e=>{c(e.target)}),n.push(null);const a=await new Promise(e=>{const t=new FileReader;t.onload=(t=>{e(t.target.result)}),t.readAsArrayBuffer(i)}),s=await e.createBuffer(a);n[o]=s,u(r,i.name),l()},!1),0===t.length?r.children[0].innerText="input signal":c(o.children[0].children[0]),h.addEventListener("click",()=>{d.click()})}void 0===Math.log10&&(Math.log10=function(e){return Math.LOG10E*Math.log(e)}),void 0===AnalyserNode.prototype.getFloatTimeDomainData&&(AnalyserNode.prototype.getFloatTimeDomainData=function(e){const t=new Uint8Array(e.length);this.getByteTimeDomainData(t);for(let n=0;n<e.length;n++)e[n]=(t[n]-128)/128}),void 0===document.createElement("input").labels&&Object.defineProperty(HTMLInputElement.prototype,"labels",{get(){return document.querySelectorAll(`label[for=${this.id}]`)}}),"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{await navigator.serviceWorker.register("sw.js",{type:"module"})}catch(e){console.warn("ServiceWorker registration failed: ",e)}});export{l as FunctionGraph,c as SignalGraph,u as setupAudio,f as setupPlayerControls};!function(){var e,t=[];function n(e){for(var t=[],n=0;n<e.numberOfChannels;n++)t[n]=e.getChannelData(n);return t}function i(e){return e.$$processors||(e.$$processors={})}"function"!=typeof AudioWorkletNode&&(self.AudioWorkletNode=function(r,o,a){var s=i(r)[o],l=r.createScriptProcessor(void 0,2,a&&a.outputChannelCount?a.outputChannelCount[0]:2),c=new Map;function u(e,t){this.eventTime=t,this.v=e}function f(e,t){this.eventTime=t,this.v1=e}function h(e,t){this.eventTime=t,this.v1=e}function d(e,t,n){this.eventTime=t,this.v1=e,this.tau=n}function m(e,t,n){this.eventTime=t,this.values=e,this.duration=n}function p(e,t,n){e.v0=t,e.t0=n}function v(e,t){for(var n=c.get(e),i=n.length-1;i>=0&&n[i].eventTime>t.eventTime;)i--;if(-1===i){var o=l.parameters.get(e).value,a=r.currentTime;t instanceof u?p(t,o,a):(n.splice(0,0,new u(o,a)),i=0)}n.splice(i+1,0,t)}if(u.prototype.func=function(e){return e>=this.eventTime?this.v:this.v0},f.prototype.func=function(e){return e>=this.eventTime?this.v1:e<=this.t0||this.v1*this.v0<=0?this.v0:this.v0*Math.pow(this.v1/this.v0,(e-this.t0)/(this.eventTime-this.t0))},h.prototype.func=function(e){return e>=this.eventTime?this.v1:e<=this.t0?this.v0:this.v0+(this.v1-this.v0)*(e-this.t0)/(this.eventTime-this.t0)},d.prototype.func=function(e){return e<=this.eventTime?this.v0:this.v1+(this.v0-this.v1)*Math.exp((this.eventTime-e)/this.tau)},m.prototype.func=function(e){if(e<=this.eventTime)return this.v0;var t=this.duration/(this.values.length-1),n=Math.floor((e-this.eventTime)/t);return n>=this.values.length-1?this.values[this.values.length-1]:this.values[n]+(this.values[n+1]-this.values[n])*(e-(n*t+this.eventTime))/t},l.parameters=new Map,s.properties)for(var g=function(e){var t=s.properties[e],n=r.createGain().gain;n.value=t.defaultValue,n.cancelAndHoldAtTime=function(e){for(var n=c.get(t.name),i=0;i<n.length&&n[i].eventTime<=e;)i++;var r=i>0?n[i-1]:null,o=i<n.length?n[i]:null;if(o instanceof h||o instanceof f){for(var a=1;a<=i;a++){var s=n[a-1].eventTime;p(n[a],n[a-1].func(s),s)}o.v1=o.func(e),o.eventTime=e,i+=1}else if(r instanceof d){for(var l=1;l<i;l++){var v=n[l-1].eventTime;p(n[l],n[l-1].func(v),v)}n.splice(i,0,new u(r.func(e),e)),i+=1}else if(r instanceof m&&e<r.eventTime+r.duration){var g=r.func(e),y=Math.floor((e-r.eventTime)/r.duration*r.values.length);r.duration=y/r.values.length*r.duration,r.values.splice(y),n.splice(i,0,new h(g,e))}n.splice(i)},n.cancelScheduledValues=function(e){for(var n=c.get(t.name),i=0;i<n.length&&n[i].eventTime<=e;)i++;n.splice(i);for(var r=1;r<i;r++){var o=n[r-1].eventTime;p(n[r],n[r-1].func(o),o)}n.push(new u(n[i-1].func(e),e))},n.exponentialRampToValueAtTime=function(e,n){n<r.currentTime&&(n=r.currentTime),v(t.name,new f(e,n))},n.linearRampToValueAtTime=function(e,n){n<r.currentTime&&(n=r.currentTime),v(t.name,new h(e,n))},n.setTargetAtTime=function(e,n,i){n<r.currentTime&&(n=r.currentTime),v(t.name,new d(e,n,i))},n.setValueAtTime=function(e,n){v(t.name,new u(e,n))},n.setValueAtTime=function(e,n,i){n<r.currentTime&&(n=r.currentTime),v(t.name,new m(Array.from(e),n,i))},l.parameters.set(t.name,n),c.set(t.name,[])},y=0;y<s.properties.length;y++)g(y);var T=new MessageChannel;e=T.port2;var b=new s.Processor(a||{});return e=null,l.port=T.port1,l.processor=s,l.instance=b,l.onaudioprocess=function(e){var i=this,o={},a=-1;this.parameters.forEach(function(e,n){var s=t[++a]||(t[a]=new Float32Array(i.bufferSize)),l=c.get(n);if(0===l.length)s.fill(e.value);else{for(var u=0;u<s.length;u++){for(var f=r.currentTime+u/r.sampleRate;0!==l.length&&f>l[0].eventTime;){if(l[0]instanceof d){if(l.length<2)break;if(l[1]instanceof d&&f<l[1].eventTime)break;e.value=l[0].func(l[1].eventTime)}else if(l[0]instanceof m){if(f<l[0].eventTime+l[0].duration)break;e.value=l[0].values[l[0].values.length-1]}else e.value=l[0].func(l[0].eventTime);l.shift(),0!==l.length&&p(l[0],e.value,f)}if(0===l.length){s.fill(e.value,u);break}s[u]=l[0].func(f)}e.value=s[s.length-1]}o[n]=s}),this.processor.realm.exec("self.sampleRate=sampleRate="+this.context.sampleRate+";self.currentTime=currentTime="+this.context.currentTime);var s=n(e.inputBuffer),l=n(e.outputBuffer);this.instance.process([s],[l],o)},l},Object.defineProperty((self.AudioContext||self.webkitAudioContext).prototype,"audioWorklet",{get:function(){return this.$$audioWorklet||(this.$$audioWorklet=new self.AudioWorklet(this))}}),self.AudioWorklet=function(){function t(e){this.$$context=e}return t.prototype.addModule=function(t,n){var r=this;return fetch(t).then(function(e){if(!e.ok)throw Error(e.status);return e.text()}).then(function(t){var o={sampleRate:0,currentTime:0,AudioWorkletProcessor:function(){this.port=e},registerProcessor:function(e,t){i(r.$$context)[e]={realm:a,context:o,Processor:t,properties:t.parameterDescriptors||[]}}};o.self=o;var a=new function(e,t){var n=document.createElement("iframe");n.style.cssText="position:absolute;left:0;top:-999px;width:1px;height:1px;",t.appendChild(n);var i=n.contentWindow,r=i.document,o="var window,$hook";for(var a in i)a in e||"eval"===a||(o+=",",o+=a);for(var s in e)o+=",",o+=s,o+="=self.",o+=s;var l=r.createElement("script");l.appendChild(r.createTextNode('function $hook(self,console) {"use strict";\n        '+o+";return function() {return eval(arguments[0])}}")),r.body.appendChild(l),this.exec=i.$hook(e,console)}(o,document.documentElement);return a.exec((n&&n.transpile||String)(t)),null})},t}())}();