import{FunctionGraph as e,setupAudio as a,setupPlayerControls as n}from"./common.js";window.addEventListener("load",(async()=>{const o=200,t=await a({init(e){const a=e.createBuffer(2,e.sampleRate*o/1e3,e.sampleRate),n=800/Math.sqrt(a.length)*e.sampleRate/44100;return{audioCtx:e,convolverNode:null,dryGainNode:null,wetGainNode:null,impulseResponseBuffer:a,set bypass(e){this._bypass=e,this.updateCoefficients()},updateCoefficients(){this.dryGainNode&&(this.dryGainNode.gain.value=this._bypass?1:0),this.wetGainNode&&(this.wetGainNode.gain.value=this._bypass?0:n)},_bypass:!1}},setup(e,a,n){e.convolverNode=e.audioCtx.createConvolver(),e.convolverNode.buffer=e.impulseResponseBuffer,a.connect(e.convolverNode),e.wetGainNode=e.audioCtx.createGain(),e.convolverNode.connect(e.wetGainNode),e.wetGainNode.connect(n),e.dryGainNode=e.audioCtx.createGain(),a.connect(e.dryGainNode),e.dryGainNode.connect(n),e.updateCoefficients()},teardown(e){e.convolverNode&&(e.convolverNode.disconnect(),e.convolverNode=null)}});n(t,[{type:"remote",label:"Drums",url:"audio/434013__mrpearch__drum-patern.mp3"},{type:"remote",label:"Speech",url:"audio/Ada_Lovelace_(By_Megan_Smith).ogx"}]);const r={x:30,y:.3},s={x:50,y:.8};let i=o;const l=e=>{if(e<r.x)return(e-r.x)*r.y/r.x+r.y;if(e<s.x){const a=(s.y-r.y)/(s.x-r.x);return(e-s.x)*a+s.y}const a=i-s.x;return a<=0?0:s.y*Math.pow(2,-(e-s.x)/a)},c=()=>{for(let e=0;e<2;e++){const a=t.proc.impulseResponseBuffer.getChannelData(e);for(let e=0;e<a.length;e++)a[e]=(2*Math.random()-1)*l(e/t.sampleRate*1e3)}t.proc.convolverNode&&(t.proc.convolverNode.buffer=t.proc.impulseResponseBuffer)};c();const d=new e(document.getElementById("funccanvas"));d.logx=!1,d.xlim=[0,o],d.xlabel="time in ms",d.ylim=[-1,1];const m=new Float32Array(t.proc.impulseResponseBuffer),p=new Float32Array(t.proc.impulseResponseBuffer),u=()=>{for(let e=0;e<m.length;e++){const a=o*e/(m.length-1);m[e]=a,p[e]=l(a)}d.drawData(m,t.proc.impulseResponseBuffer.getChannelData(0),"#00685e",m,p),d.drawMarkers([[r.x,r.y],[s.x,s.y],[i,0]])};d.addEventListener("markermove",(e=>{0===e.marker&&(r.x=Math.max(Math.min(e.valX,s.x),0),r.y=Math.max(Math.min(e.valY,1),0)),1===e.marker&&(s.x=Math.max(Math.min(e.valX,i),r.x),s.y=Math.max(Math.min(e.valY,1),0)),2===e.marker&&(i=Math.max(Math.min(e.valX,o),s.x)),u()})),d.addEventListener("markermoveend",(()=>{c(),u()})),document.getElementById("bypass").onchange=function(e){t.proc.bypass=e.target.checked},u()}));