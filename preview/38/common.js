const e="object"==typeof global?global:self,t=[].findIndex||function(e,t){let n=this.length;for(;n--;)if(e.call(t,this[n]))return n;return n},n=Object.defineProperty,i="__event-target__"+Math.random(),o=e.WeakMap||function(){return{get:e=>e[i],set(e,t){n(e,i,{configurable:!0,value:t})}}};let r=e.EventTarget;try{new r}catch(e){r=(()=>{const e=new o,i=t=>e.get(t)||r(t),r=t=>{const n=new f;return e.set(t,n),n},a=(e,t)=>{for(const i in t)n(e,i,{configurable:!0,value:t[i]})};function s(){}function l(e){const t=e.options;t&&t.once&&u.call(e.target,this.type,e.listener,e.options),"function"==typeof e.listener?e.listener.call(e.target,this):e.listener.handleEvent(this)}function c(e){return this===e.listener}function u(e,n,o){const r=i(this)[e];if(r){const e=t.call(r,c,n);-1<e&&r.splice(e,1)}}function f(){}return a(s.prototype,{addEventListener:function(e,n,o){const r=i(this),a=r[e]||(r[e]=[]);t.call(a,c,n)<0&&a.push({target:this,listener:n,options:o})},dispatchEvent:function(e){const t=i(this)[e.type];t&&(a(e,{currentTarget:this,target:this}),t.forEach(l,e),delete e.currentTarget,delete e.target);return!0},removeEventListener:u}),f.prototype=Object.create(null),s})()}var a=r;function s(e){const{width:t,height:n}=e,i=e.getContext("2d");let o=!0,r=2e4,a=50,s=null,l=0,c=-80,u=null,f=[],h=null,d=null,p=null,m=30;let v=t-m-10;const g=10;let y=17,T=n-g-y,w=null;const b=function(e){return(r-a)*(e-m)/v+a},x=function(e){return a*Math.pow(10,Math.log10(r/a)*(e-m)/v)};let k=x;const M=function(e){return(e-a)*v/(r-a)+m},A=function(e){return Math.log10(e/a)/Math.log10(r/a)*v+m};let E=A;const D=function(e){return g+T/(c-l)*(e-l)},P=function(e){const t=Math.pow(10,Math.floor(Math.log10(e)));return(e/=t)>5?e=10:e>2?e=5:e>1&&(e=2),e*t},C=function(){i.clearRect(0,0,t,n),i.font="12px sans-serif",i.textBaseline="middle",i.textAlign="end";const e=P((r-a)/v*30),f=P((l-c)/T*20),h=f>=1?0:-Math.floor(Math.log10(f));for(let e=Math.floor(l/f)*f;e>=c;e-=f)i.strokeStyle="rgb(0, 0, 0)",i.fillText(e.toFixed(h),m-2,D(e));if(i.textBaseline="top",i.textAlign="center",i.setTransform(0,-1,1,0,0,0),u&&i.fillText(u,-(T/2+g),0),i.setTransform(1,0,0,1,0,0),o){i.strokeStyle="rgb(0, 0, 0)";for(let e=Math.pow(10,Math.ceil(Math.log10(a)));e<=r;e*=10)i.fillText(e,E(e),n-y+2)}else{i.strokeStyle="rgb(0, 0, 0)";const t=e>=1?0:-Math.floor(Math.log10(e));for(let o=Math.ceil(a/e)*e;o<=r;o+=e)i.fillText(o.toFixed(t),E(o),n-y+2)}s&&i.fillText(s,m+(t-m)/2,n-y+16);for(let e=Math.floor(l/f)*f;e>=c;e-=f)i.strokeStyle="rgb(100, 100, 100)",i.beginPath(),i.moveTo(E(a),D(e)),i.lineTo(E(r),D(e)),i.stroke();if(o){let e=Math.pow(10,Math.floor(Math.log10(a))),t=Math.ceil(a/e)*e;for(i.strokeStyle="rgb(100, 100, 100)";t<=r;){i.beginPath();const n=E(t);i.moveTo(n,D(l)),i.lineTo(n,D(c)),i.stroke(),t+=e,t>=9.99*e&&(e*=10)}}else for(let t=Math.ceil(a/e)*e;t<=r;t+=e){i.beginPath();const e=E(t);i.moveTo(e,D(l)),i.lineTo(e,D(c)),i.stroke()}i.rect(E(a),D(c),E(r)-E(a),D(l)-D(c)),i.stroke(),w=i.getImageData(0,0,t,n)};this.drawData=function(...e){for(i.putImageData(w,0,0),i.save(),i.beginPath(),i.rect(m,g,t-m-10,n-y-g),i.clip();e.length>=2;){const t=e.shift(),n=e.shift();e.length>=1&&"string"==typeof e[0]?i.strokeStyle=e.shift():i.strokeStyle="rgb(0, 0, 0)",i.beginPath(),i.moveTo(E(t[0]),D(n[0]));for(let e=1;e<n.length;e++)i.lineTo(E(t[e]),D(n[e]));i.stroke()}i.restore()},this.drawMarkers=function(e){i.save(),i.fillStyle="rgb(165, 0, 52)",f=[];for(const t of e)f.push([E(t[0]),D(t[1])]),i.beginPath(),i.arc(E(t[0]),D(t[1]),4,0,2*Math.PI),i.fill();i.restore()},Object.defineProperty(this,"xlim",{get:()=>[a,a],set(e){[a,r]=e,C()}}),Object.defineProperty(this,"ylim",{get:()=>[c,c],set(e){[c,l]=e,C()}}),Object.defineProperty(this,"logx",{get:()=>o,set(e){o=e,o?(k=x,E=A):(k=b,E=M),C()}}),Object.defineProperty(this,"xlabel",{get:()=>s,set(e){s=e,y=s?30:16,T=n-g-y,C()}}),Object.defineProperty(this,"ylabel",{get:()=>u,set(e){u=e,m=u?44:30,v=t-m-10,C()}});const L=(e,t,n)=>{h=null;let i=n;for(let n=0;n<f.length;n++){const o=f[n],r=Math.hypot(e-o[0],t-o[1]);r<=i&&(h=n,i=r)}null!==h&&(d=e-f[h][0],p=t-f[h][1])};e.addEventListener("mousedown",(e=>{0===e.button&&L(e.offsetX,e.offsetY,6)})),e.addEventListener("touchstart",(e=>{e.preventDefault(),null===h&&L(e.touches.item(0).pageX-e.target.offsetLeft,e.touches.item(0).pageY-e.target.offsetTop,40)}));const B=()=>{if(null!==h){const e=new Event("markermoveend");e.marker=h,this.dispatchEvent(e),h=null}};e.addEventListener("mouseup",(e=>{0===e.button&&B()})),e.addEventListener("touchend",(e=>{e.preventDefault(),0===e.touches.length&&B()}));const W=(e,t)=>{if(null===h)return;const n=new Event("markermove");n.marker=h,n.valX=k(e-d),n.valY=function(e){return l+(e-g)*(c-l)/T}(t-p),this.dispatchEvent(n)};e.addEventListener("mousemove",(e=>{1===e.buttons?W(e.offsetX,e.offsetY):B()})),e.addEventListener("touchmove",(e=>{e.preventDefault(),W(e.touches.item(0).pageX-e.target.offsetLeft,e.touches.item(0).pageY-e.target.offsetTop)}))}class l extends a{constructor(e){super(),s.call(this,e)}}function c(e,t){const n=new l(t);let i=!1,o=!1;Object.defineProperty(this,"drawWave",{get:()=>i,set(t){i=t,t?(n.logx=!1,n.ylim=[-1,1],n.xlim=[0,e.timeIndices.length-1],n.xlabel="time in samples",n.ylabel="amplitude"):(n.xlim=[50,2e4],n.logx=!o,n.ylim=[-130,0],n.xlabel="frequency in Hz",n.ylabel="magnitude in dB")}}),Object.defineProperty(this,"freqLinear",{get:()=>o,set(e){o=e,i||(n.logx=!o)}}),this.drawWave=!1,function t(){if(setTimeout((()=>requestAnimationFrame(t)),40),i){const t=e.getTimeDomainData();n.drawData(e.timeIndices,t)}else{const t=e.getFrequencyDomainData();n.drawData(e.frequencies,t)}}()}async function u(...e){const t=new(window.AudioContext||window.webkitAudioContext)({latencyHint:"playback"});let n=null,i=null,o=null;const r=t.createAnalyser();r.smoothingTimeConstant=.3,r.minDecibels=-130,r.fftSize=1024;const a=new Float32Array(r.fftSize),s=new Float32Array(r.frequencyBinCount);r.connect(t.destination);let l=function(){};await t.audioWorklet.addModule("noisesourceproc.js");const c="object"==typeof e[0]?e[0]:function(e,t){return{init:async n=>{await n.audioWorklet.addModule(e);const i=new AudioWorkletNode(n,t);i.port.postMessage({action:"list-properties"});const o=await(r=i.port,new Promise((e=>{const t=r.onmessage;r.onmessage=n=>{r.onmessage=t,e(n.data)}})));var r;if("list-properties"===o.response)for(const e of o.properties)Object.defineProperty(i,e,{set(t){i.port.postMessage({action:"set-property",param:e,value:t})}});return i},setup:(e,t,n)=>{t.connect(e),e.connect(n)},teardown:e=>{e.disconnect()}}}(...e),u=await c.init(t),f=new Float32Array(r.frequencyBinCount);for(let e=0;e<f.length;e++)f[e]=e*t.sampleRate/2/(f.length-1);const h=new Float32Array(r.fftSize);for(let e=0;e<h.length;e++)h[e]=e;const d=function(){null!==n&&(n.disconnect(),n=null),null!==i&&(i.disconnect(),i=null),c.teardown(u),t.suspend()};return d(),{start:function(e){if(d(),t.resume(),e instanceof AudioBuffer)n=t.createBufferSource(),n.buffer=e,n.onended=()=>{d(),l()},n.start(),c.setup(u,n,r);else if("sine"===e.type)n=t.createOscillator(),n.type="sine",n.frequency.value=e.frequency,n.start(),i=t.createGain(),i.gain.value=e.gain,n.connect(i),c.setup(u,i,r);else if("noise"===e.type){if(i=t.createGain(),i.gain.value=e.gain,n=new AudioWorkletNode(t,"noisesource-processor",{numberOfInputs:0,outputChannelCount:[1]}),e.filter&&0!==e.filter.length){o=t.createConvolver();const r=t.createBuffer(1,e.filter.length,t.sampleRate);r.getChannelData(0).set(e.filter),o.normalize=!1,o.buffer=r,n.connect(o),o.connect(i)}else n.connect(i);c.setup(u,i,r)}},stop:d,isPlaying:()=>null!==n,createBuffer:e=>new Promise((n=>{t.decodeAudioData(e,n)})),set onended(e){l=e},getTimeDomainData:function(){return r.getFloatTimeDomainData(a),a},timeIndices:h,getFrequencyDomainData:function(){return r.getFloatFrequencyData(s),s},frequencies:f,proc:u,get currentTime(){return t.currentTime},get sampleRate(){return t.sampleRate}}}function f(e,t){const n=[];let i=null;const o=document.getElementById("source-select"),r=o.children[1];o.children[0].addEventListener("click",(e=>{e.stopPropagation(),r.style.visibility="visible"===r.style.visibility?"hidden":"visible"}),!1),document.addEventListener("click",(()=>{r.style.visibility="hidden"}),!1);const a=document.getElementById("play"),s=document.getElementById("stop");function l(){e.isPlaying()?(a.disabled=!0,s.disabled=!1):(s.disabled=!0,a.disabled=!n[i])}function c(t){i=t.getAttribute("data-source-idx"),o.children[0].innerText=t.textContent,function e(t){t.classList.remove("selected"),Array.from(t.children).forEach(e)}(r),t.classList.add("selected"),e.stop(),l()}function u(e,t){e.innerText=t,e.getAttribute("data-source-idx")===i&&(o.children[0].innerText=t)}t.forEach((async function(t){const i=document.createElement("div");if(i.setAttribute("data-source-idx",n.length),r.children[0].append(i),i.addEventListener("click",(e=>{c(e.target)})),"remote"===t.type){i.innerText=`${t.label} (loading...)`;const o=n.length;n.push(null);const r=await window.fetch(t.url);n[o]=await e.createBuffer(await r.arrayBuffer()),u(i,t.label)}else if("sine"===t.type){const e=t.frequency||440;i.innerText=t.label||`${e} Hz sine`,n.push({type:"sine",frequency:e,gain:t.gain||.5})}else"noise"===t.type&&(i.innerText=t.label||"Noise",n.push({type:"noise",filter:t.filter||[],gain:t.gain||.5}));l()})),e.onended=l,s.onclick=function(){e.stop(),l()},a.onclick=function(){e.start(n[i]),l()};const f=r.children[1],h=f.children[0],d=document.createElement("input");d.type="file",d.accept="audio/*",d.addEventListener("change",(async t=>{const i=t.target.files[0];if(!i)return;const o=document.createElement("div");o.setAttribute("data-source-idx",n.length),o.innerText=`${i.name} (loading...)`,c(o),f.insertBefore(o,h);const r=n.length;o.addEventListener("click",(e=>{c(e.target)})),n.push(null);const a=await new Promise((e=>{const t=new FileReader;t.onload=t=>{e(t.target.result)},t.readAsArrayBuffer(i)}));n[r]=await e.createBuffer(a),u(o,i.name),l()}),!1),0===t.length?o.children[0].innerText="input signal":c(r.children[0].children[0]),h.addEventListener("click",(()=>{d.click()}))}void 0===Math.log10&&(Math.log10=function(e){return Math.LOG10E*Math.log(e)}),void 0===AnalyserNode.prototype.getFloatTimeDomainData&&(AnalyserNode.prototype.getFloatTimeDomainData=function(e){const t=new Uint8Array(e.length);this.getByteTimeDomainData(t);for(let n=0;n<e.length;n++)e[n]=(t[n]-128)/128}),void 0===document.createElement("input").labels&&Object.defineProperty(HTMLInputElement.prototype,"labels",{get(){return document.querySelectorAll(`label[for=${this.id}]`)}}),"serviceWorker"in navigator&&window.addEventListener("load",(async()=>{try{await navigator.serviceWorker.register("sw.js",{type:"module"})}catch(e){console.warn("ServiceWorker registration failed: ",e)}}));export{l as FunctionGraph,c as SignalGraph,u as setupAudio,f as setupPlayerControls};!function(){function e(e,t){var n=document.createElement("iframe");n.style.cssText="position:absolute;left:0;top:-999px;width:1px;height:1px;",t.appendChild(n);var i=n.contentWindow,o=i.document,r="var window,$hook";for(var a in i)a in e||"eval"===a||(r+=",",r+=a);for(var s in e)r+=",",r+=s,r+="=self.",r+=s;var l=o.createElement("script");l.appendChild(o.createTextNode('function $hook(self,console) {"use strict";\n        '+r+";return function() {return eval(arguments[0])}}")),o.body.appendChild(l),this.exec=i.$hook(e,console)}var t,n=[];function i(e){for(var t=[],n=0;n<e.numberOfChannels;n++)t[n]=e.getChannelData(n);return t}function o(e){return e.$$processors||(e.$$processors={})}"function"!=typeof AudioWorkletNode&&(self.AudioWorkletNode=function(e,r,a){var s=o(e)[r],l=e.createScriptProcessor(void 0,2,a&&a.outputChannelCount?a.outputChannelCount[0]:2),c=new Map;function u(e,t){this.eventTime=t,this.v=e}function f(e,t){this.eventTime=t,this.v1=e}function h(e,t){this.eventTime=t,this.v1=e}function d(e,t,n){this.eventTime=t,this.v1=e,this.tau=n}function p(e,t,n){this.eventTime=t,this.values=e,this.duration=n}function m(e,t,n){e.v0=t,e.t0=n}function v(t,n){for(var i=c.get(t),o=i.length-1;o>=0&&i[o].eventTime>n.eventTime;)o--;if(-1===o){var r=l.parameters.get(t).value,a=e.currentTime;n instanceof u?m(n,r,a):(i.splice(0,0,new u(r,a)),o=0)}i.splice(o+1,0,n)}if(u.prototype.func=function(e){return e>=this.eventTime?this.v:this.v0},f.prototype.func=function(e){return e>=this.eventTime?this.v1:e<=this.t0||this.v1*this.v0<=0?this.v0:this.v0*Math.pow(this.v1/this.v0,(e-this.t0)/(this.eventTime-this.t0))},h.prototype.func=function(e){return e>=this.eventTime?this.v1:e<=this.t0?this.v0:this.v0+(this.v1-this.v0)*(e-this.t0)/(this.eventTime-this.t0)},d.prototype.func=function(e){return e<=this.eventTime?this.v0:this.v1+(this.v0-this.v1)*Math.exp((this.eventTime-e)/this.tau)},p.prototype.func=function(e){if(e<=this.eventTime)return this.v0;var t=this.duration/(this.values.length-1),n=Math.floor((e-this.eventTime)/t);return n>=this.values.length-1?this.values[this.values.length-1]:this.values[n]+(this.values[n+1]-this.values[n])*(e-(n*t+this.eventTime))/t},l.parameters=new Map,s.properties)for(var g=function(t){var n=s.properties[t],i=e.createGain().gain;i.value=n.defaultValue,i.cancelAndHoldAtTime=function(e){for(var t=c.get(n.name),i=0;i<t.length&&t[i].eventTime<=e;)i++;var o=i>0?t[i-1]:null,r=i<t.length?t[i]:null;if(r instanceof h||r instanceof f){for(var a=1;a<=i;a++){var s=t[a-1].eventTime;m(t[a],t[a-1].func(s),s)}r.v1=r.func(e),r.eventTime=e,i+=1}else if(o instanceof d){for(var l=1;l<i;l++){var v=t[l-1].eventTime;m(t[l],t[l-1].func(v),v)}t.splice(i,0,new u(o.func(e),e)),i+=1}else if(o instanceof p&&e<o.eventTime+o.duration){var g=o.func(e),y=Math.floor((e-o.eventTime)/o.duration*o.values.length);o.duration=y/o.values.length*o.duration,o.values.splice(y),t.splice(i,0,new h(g,e))}t.splice(i)},i.cancelScheduledValues=function(e){for(var t=c.get(n.name),i=0;i<t.length&&t[i].eventTime<=e;)i++;t.splice(i);for(var o=1;o<i;o++){var r=t[o-1].eventTime;m(t[o],t[o-1].func(r),r)}i>0&&t.push(new u(t[i-1].func(e),e))},i.exponentialRampToValueAtTime=function(t,i){i<e.currentTime&&(i=e.currentTime),v(n.name,new f(t,i))},i.linearRampToValueAtTime=function(t,i){i<e.currentTime&&(i=e.currentTime),v(n.name,new h(t,i))},i.setTargetAtTime=function(t,i,o){i<e.currentTime&&(i=e.currentTime),v(n.name,new d(t,i,o))},i.setValueAtTime=function(e,t){v(n.name,new u(e,t))},i.setValueAtTime=function(t,i,o){i<e.currentTime&&(i=e.currentTime),v(n.name,new p(Array.from(t),i,o))},l.parameters.set(n.name,i),c.set(n.name,[])},y=0;y<s.properties.length;y++)g(y);var T=new MessageChannel;t=T.port2;var w=new s.Processor(a||{});return t=null,l.port=T.port1,l.processor=s,l.instance=w,l.onaudioprocess=function(t){var o=this,r={},a=-1;this.parameters.forEach((function(t,i){var s=n[++a]||(n[a]=new Float32Array(o.bufferSize)),l=c.get(i);if(0===l.length)s.fill(t.value);else{for(var u=0;u<s.length;u++){for(var f=e.currentTime+u/e.sampleRate;0!==l.length&&f>l[0].eventTime;){if(l[0]instanceof d){if(l.length<2)break;if(l[1]instanceof d&&f<l[1].eventTime)break;t.value=l[0].func(l[1].eventTime)}else if(l[0]instanceof p){if(f<l[0].eventTime+l[0].duration)break;t.value=l[0].values[l[0].values.length-1]}else t.value=l[0].func(l[0].eventTime);l.shift(),0!==l.length&&m(l[0],t.value,f)}if(0===l.length){s.fill(t.value,u);break}s[u]=l[0].func(f)}t.value=s[s.length-1]}r[i]=s})),this.processor.realm.exec("self.sampleRate=sampleRate="+this.context.sampleRate+";self.currentTime=currentTime="+this.context.currentTime);var s=i(t.inputBuffer),l=i(t.outputBuffer);this.instance.process([s],[l],r)},l},Object.defineProperty((self.AudioContext||self.webkitAudioContext).prototype,"audioWorklet",{get:function(){return this.$$audioWorklet||(this.$$audioWorklet=new self.AudioWorklet(this))}}),self.AudioWorklet=function(){function n(e){this.$$context=e}return n.prototype.addModule=function(n,i){var r=this;return fetch(n).then((function(e){if(!e.ok)throw Error(e.status);return e.text()})).then((function(n){var a={sampleRate:0,currentTime:0,AudioWorkletProcessor:function(){this.port=t},registerProcessor:function(e,t){o(r.$$context)[e]={realm:s,context:a,Processor:t,properties:t.parameterDescriptors||[]}}};a.self=a;var s=new e(a,document.documentElement);return s.exec((i&&i.transpile||String)(n)),null}))},n}())}();