import{FunctionGraph as e,setupAudio as t,setupPlayerControls as a}from"./common.js";window.addEventListener("load",(async()=>{const o=await t("drcproc.js","drc-processor");a(o,[{type:"remote",label:"Funk",url:"audio/unfinite_function.mp3"},{type:"remote",label:"Orchestra",url:"audio/DittersdorfOvid2.ogx"}]);const n={in:-80,out:-45},r={in:-10,out:-10};o.proc.bypass=!1,o.proc.newyorkstyle=!1,o.proc.parameters.get("limiterThreshold").value=r.in,o.proc.parameters.get("limiterLevel").value=r.out,o.proc.parameters.get("noiseThreshold").value=n.in,o.proc.parameters.get("compressionRatio").value=(r.in-n.in)/(r.out-n.out);const i=new e(document.getElementById("funccanvas"));i.logx=!1,i.xlim=[-90,0],i.xlabel="input level in dB",i.ylim=[-90,0],i.ylabel="output level in dB";const l=()=>{i.drawData([n.in,n.in,r.in,0],[-120,n.out,r.out,r.out]),i.drawMarkers([[n.in,n.out],[r.in,r.out]])};i.addEventListener("markermove",(e=>{0===e.marker?(n.in=Math.max(Math.min(e.valX,r.in),-90),n.out=Math.max(Math.min(e.valY,r.out-.1),-90),o.proc.parameters.get("noiseThreshold").value=n.in,o.proc.parameters.get("compressionRatio").value=(r.in-n.in)/(r.out-n.out)):1===e.marker&&(r.in=Math.max(Math.min(e.valX,0),n.in),r.out=Math.max(Math.min(e.valY,0),n.out+.1),o.proc.parameters.get("limiterThreshold").value=r.in,o.proc.parameters.get("limiterLevel").value=r.out,o.proc.parameters.get("compressionRatio").value=(r.in-n.in)/(r.out-n.out)),l()})),l();const m=new e(document.getElementById("inputenvcanvas"));m.logx=!1,m.xlim=[-512e3/o.sampleRate,0],m.xlabel="time in s",m.ylim=[-1,1],m.envelopeMode=!0;const s=new e(document.getElementById("outputenvcanvas"));s.logx=!1,s.xlim=[-512e3/o.sampleRate,0],s.xlabel="time in s",s.ylim=[-1,1],s.envelopeMode=!0,o.proc.envelopeSubsampling=2e3;const c=new Float32Array(256);for(let e=0;e<c.length;e++)c[e]=2e3*(e-256+1)/o.sampleRate;o.proc.port.onmessage=e=>{var t,a;t=e.data.inputEnvelope,a=e.data.outputEnvelope,m.drawData(c,t),s.drawData(c,a)},document.getElementById("newyork").onchange=function(e){o.proc.newYorkStyle=e.target.checked,document.getElementById("diagram").src=e.target.checked?"images/drc/diag1.png":"images/drc/diag2.png"},document.getElementById("bypass").onchange=function(e){o.proc.bypass=e.target.checked}}));