import{FunctionGraph as e,setupAudio as o,setupPlayerControls as a}from"./common.js";window.addEventListener("load",(async()=>{const n=200,t=await o({init(e){const o=e.createBuffer(2,e.sampleRate*n/1e3,e.sampleRate),a=800/Math.sqrt(o.length)*e.sampleRate/44100;return{audioCtx:e,convolverNode:null,dryGainNode:null,wetGainNode:null,impulseResponseBuffer:o,set bypass(e){this._bypass=e,this.updateCoefficients()},updateCoefficients(){this.dryGainNode&&(this.dryGainNode.gain.value=this._bypass?1:0),this.wetGainNode&&(this.wetGainNode.gain.value=this._bypass?0:a)},_bypass:!1}},setup(e,o,a){e.convolverNode=e.audioCtx.createConvolver(),e.convolverNode.buffer=e.impulseResponseBuffer,o.connect(e.convolverNode),e.wetGainNode=e.audioCtx.createGain(),e.convolverNode.connect(e.wetGainNode),e.wetGainNode.connect(a),e.dryGainNode=e.audioCtx.createGain(),o.connect(e.dryGainNode),e.dryGainNode.connect(a),e.updateCoefficients()},teardown(e){e.convolverNode&&(e.convolverNode.disconnect(),e.convolverNode=null)}});a(t,[{type:"remote",label:"Drums",url:"audio/434013__mrpearch__drum-patern.mp3"},{type:"remote",label:"Speech",url:"audio/Ada_Lovelace_(As_Told_By_U.S._Chief_Technology_Officer_Megan_Smith).mp3"}]);const r={x:30,y:.3},s={x:50,y:.8};let i=n;const l=e=>{if(e<r.x)return(e-r.x)*r.y/r.x+r.y;if(e<s.x){const o=(s.y-r.y)/(s.x-r.x);return(e-s.x)*o+s.y}const o=i-s.x;return o<=0?0:s.y*Math.pow(2,-(e-s.x)/o)},c=()=>{for(let e=0;e<2;e++){const o=t.proc.impulseResponseBuffer.getChannelData(e);for(let e=0;e<o.length;e++)o[e]=(2*Math.random()-1)*l(e/t.sampleRate*1e3)}t.proc.convolverNode&&(t.proc.convolverNode.buffer=t.proc.impulseResponseBuffer)};c();const d=new e(document.getElementById("funccanvas"));d.logx=!1,d.xlim=[0,n],d.xlabel="time in ms",d.ylim=[-1,1];const m=new Float32Array(t.proc.impulseResponseBuffer),p=new Float32Array(t.proc.impulseResponseBuffer),u=()=>{for(let e=0;e<m.length;e++){const o=n*e/(m.length-1);m[e]=o,p[e]=l(o)}d.drawData(m,t.proc.impulseResponseBuffer.getChannelData(0),"#00685e",m,p),d.drawMarkers([[r.x,r.y],[s.x,s.y],[i,0]])};d.addEventListener("markermove",(e=>{0===e.marker&&(r.x=Math.max(Math.min(e.valX,s.x),0),r.y=Math.max(Math.min(e.valY,1),0)),1===e.marker&&(s.x=Math.max(Math.min(e.valX,i),r.x),s.y=Math.max(Math.min(e.valY,1),0)),2===e.marker&&(i=Math.max(Math.min(e.valX,n),s.x)),u()})),d.addEventListener("markermoveend",(()=>{c(),u()})),document.getElementById("bypass").onchange=function(e){t.proc.bypass=e.target.checked},u()}));